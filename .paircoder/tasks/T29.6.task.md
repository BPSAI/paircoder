---
id: T29.6
title: Implement Network Allowlist
status: pending
priority: P1
complexity: 35
plan: plan-2026-01-sprint-29-contained-autonomy
depends_on: [T29.3]
---

# Objective

Restrict network access to only allowed domains during containment mode.

# Files to Update

| File | Change |
|------|--------|
| `tools/cli/bpsai_pair/security/network.py` | Create `NetworkGuard` class and `NetworkRestrictionError` |

# Implementation Plan

1. Create `NetworkRestrictionError` exception class

2. Create `NetworkGuard` class with:
   - `__init__(allowed_domains: list[str])`
   - `check_url(url: str)` - raises `NetworkRestrictionError` if blocked
   - `_is_allowed(domain: str) -> bool` - check domain against allowlist

3. Always allow localhost:
   - `localhost`
   - `127.0.0.1`
   - `::1`

4. Support subdomain matching:
   - Allow `api.github.com` if `github.com` is in allowlist

5. Handle URL parsing correctly:
   - Extract domain from URL
   - Handle ports correctly

# Acceptance Criteria

- [ ] Network check hooks into subprocess/request calls (documentation for integration)
- [ ] Allowed domains pass through
- [ ] Blocked domains raise `NetworkRestrictionError`
- [ ] Subdomain of allowed domain passes
- [ ] Localhost always allowed
- [ ] IP address handling works

# Verification

```bash
# Run network tests
pytest tests/security/test_network.py -v

# Manual test
python -c "
from bpsai_pair.security.network import NetworkGuard

guard = NetworkGuard(['github.com', 'api.trello.com'])
guard.check_url('https://github.com/user/repo')  # OK
guard.check_url('https://api.github.com/repos')  # OK (subdomain)
guard.check_url('http://localhost:8080')  # OK
try:
    guard.check_url('https://evil.com')
except Exception as e:
    print(f'Blocked: {e}')
"
```

# Implementation Notes

```python
# tools/cli/bpsai_pair/security/network.py

from urllib.parse import urlparse

class NetworkRestrictionError(Exception):
    """Raised when network access to blocked domain is attempted."""
    pass

class NetworkGuard:
    def __init__(self, allowed_domains: list[str]):
        self.allowed = set(allowed_domains)
        # Always allow localhost
        self.allowed.add("localhost")
        self.allowed.add("127.0.0.1")
        self.allowed.add("::1")

    def check_url(self, url: str) -> None:
        """Raise NetworkRestrictionError if URL not in allowlist."""
        parsed = urlparse(url)
        domain = parsed.netloc.split(':')[0]  # Remove port

        if not self._is_allowed(domain):
            raise NetworkRestrictionError(
                f"Network access to '{domain}' blocked in containment mode.\n"
                f"Allowed domains: {', '.join(sorted(self.allowed))}"
            )

    def _is_allowed(self, domain: str) -> bool:
        """Check if domain is in allowlist (including subdomains)."""
        if domain in self.allowed:
            return True

        # Check subdomain match
        for allowed in self.allowed:
            if domain.endswith(f".{allowed}"):
                return True

        return False
```

# Test Cases

- Allowed domain passes check
- Subdomain of allowed domain passes
- Blocked domain raises error
- Localhost always allowed
- IP address handling works
