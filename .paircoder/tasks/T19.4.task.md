---
id: T19.4
title: Token-Aware Batch Planning
plan: plan-2025-12-sprint-19-methodology
type: feature
priority: P1
complexity: 40
status: done
depends_on: []
tags:
- planning
- tokens
- estimation
---

# Objective

Estimate token usage for a plan and suggest batching if it exceeds comfortable limits. Prevent plans too large to complete in one session.

# Implementation

## Token Estimation

Use existing `token_estimates` config:

```yaml
token_estimates:
  base_context: 15000
  per_complexity_point: 500
  by_task_type:
    feature: 1.2
    bugfix: 0.8
    docs: 0.6
  per_file_touched: 2000
```

## CLI Output

```bash
$ bpsai-pair plan estimate sprint-19-methodology

Plan Token Estimate:
  Base context:     15,000
  Tasks (7):        35,000  (avg 5,000 per task)
  Files touched:    14,000  (7 files × 2,000)
  ─────────────────────────
  Total estimate:   64,000 tokens

⚠️ This plan may exceed comfortable session limits.

Recommendations:
  1. Split into 2 batches (T19.1-T19.4, T19.5-T19.9)
  2. Use intermediate commits for recovery points
  3. Update state.md frequently
```

# Acceptance Criteria

- [ ] `bpsai-pair plan estimate <plan-id>` command exists
- [ ] Uses existing token_estimates config from config.yaml
- [ ] Shows breakdown: base context, tasks, files touched
- [ ] Warns when plan exceeds threshold (configurable, default 50k)
- [ ] Suggests batching strategy when threshold exceeded
- [ ] Factors in task types (feature vs bugfix multipliers)
- [ ] Unit tests for estimation logic

# Files to Modify

- `src/bpsai_pair/planning/cli_commands.py` - Add estimate command
- `src/bpsai_pair/planning/token_estimator.py` - New module
- `.paircoder/config.yaml` - Ensure token_estimates exists
- `tests/test_plan_estimate.py`

# Dependencies

None