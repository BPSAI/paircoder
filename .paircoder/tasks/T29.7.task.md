---
id: T29.7
title: Test Containment Escape Attempts
status: pending
priority: P0
complexity: 45
plan: plan-2026-01-sprint-29-contained-autonomy
depends_on: [T29.4]
---

# Objective

Create comprehensive tests that attempt to bypass containment restrictions. These tests ensure the containment is secure against common bypass techniques.

# Files to Update

| File | Change |
|------|--------|
| `tests/security/test_containment_escapes.py` | Create comprehensive escape test suite |

# Implementation Plan

1. Create test fixtures for containment environment

2. Implement symlink escape tests:
   - `test_symlink_to_locked_dir`
   - `test_symlink_chain_to_locked_file`
   - `test_relative_symlink_escape`

3. Implement path traversal escape tests:
   - `test_dotdot_traversal`
   - `test_double_slash_traversal`
   - `test_encoded_path_traversal`
   - `test_null_byte_injection`

4. Implement filesystem escape tests:
   - `test_hardlink_to_locked_file`
   - `test_rename_locked_directory`
   - `test_move_file_to_locked_dir`

5. Implement process escape tests:
   - `test_subprocess_with_modified_path`
   - `test_shell_command_injection`
   - `test_env_var_override`

6. Implement network escape tests:
   - `test_ip_instead_of_domain`
   - `test_redirect_to_blocked_domain`

7. Verify all escape attempts are logged to audit

# Acceptance Criteria

- [ ] 20+ escape attempt test cases
- [ ] Symlink bypass attempts blocked
- [ ] Relative path traversal blocked (../)
- [ ] Hardlink bypass attempts blocked
- [ ] Subprocess spawn with modified PATH blocked
- [ ] Environment variable injection blocked
- [ ] All escape attempts logged to audit

# Verification

```bash
# Run all escape tests
pytest tests/security/test_containment_escapes.py -v

# Verify count
pytest tests/security/test_containment_escapes.py --collect-only | grep "test_" | wc -l
# Should be >= 20
```

# Implementation Notes

```python
# tests/security/test_containment_escapes.py

import pytest
from pathlib import Path
from bpsai_pair.security.containment import ContainmentManager, ContainmentViolationError
from bpsai_pair.core.config import ContainmentConfig

@pytest.fixture
def containment_manager(tmp_path):
    """Create a sandbox manager with locked paths."""
    locked_dir = tmp_path / ".claude" / "agents"
    locked_dir.mkdir(parents=True)
    locked_file = tmp_path / "CLAUDE.md"
    locked_file.touch()

    config = ContainmentConfig(
        enabled=True,
        locked_directories=[".claude/agents/"],
        locked_files=["CLAUDE.md"]
    )
    manager = ContainmentManager(config, tmp_path)
    manager.activate()
    return manager, tmp_path


class TestSymlinkEscapes:
    """Attempts to bypass via symlinks."""

    def test_symlink_to_locked_dir(self, containment_manager):
        manager, root = containment_manager
        # Create symlink pointing to locked dir
        symlink = root / "sneaky_link"
        symlink.symlink_to(root / ".claude" / "agents")

        with pytest.raises(ContainmentViolationError):
            manager.check_write_allowed(symlink / "planner.md")

    def test_symlink_chain_to_locked_file(self, containment_manager):
        manager, root = containment_manager
        # Create chain: link1 -> link2 -> locked file
        link2 = root / "link2"
        link2.symlink_to(root / "CLAUDE.md")
        link1 = root / "link1"
        link1.symlink_to(link2)

        with pytest.raises(ContainmentViolationError):
            manager.check_write_allowed(link1)


class TestPathTraversalEscapes:
    """Attempts to bypass via path manipulation."""

    def test_dotdot_traversal(self, containment_manager):
        manager, root = containment_manager
        # Try .claude/../.claude/agents
        sneaky_path = Path(".claude/../.claude/agents/planner.md")

        with pytest.raises(ContainmentViolationError):
            manager.check_write_allowed(sneaky_path)


class TestFilesystemEscapes:
    """Attempts to bypass via filesystem tricks."""

    def test_rename_locked_directory(self, containment_manager):
        manager, root = containment_manager
        # Try to rename .claude/agents to something else
        with pytest.raises(ContainmentViolationError):
            manager.check_write_allowed(root / ".claude" / "agents")


class TestNetworkEscapes:
    """Attempts to bypass network restrictions."""
    pass  # Implemented with NetworkGuard tests
```

# Test Categories Summary

| Category | Tests |
|----------|-------|
| Symlink Escapes | 3-4 tests |
| Path Traversal | 4-5 tests |
| Filesystem Tricks | 3-4 tests |
| Process Manipulation | 3-4 tests |
| Network Escapes | 3-4 tests |
| Environment Injection | 2-3 tests |
| **Total** | **20+ tests** |

# Deliverables

- Test file with 20+ test cases
- All tests passing (escapes blocked)
- Audit log contains all attempts
