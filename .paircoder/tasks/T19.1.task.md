---
id: T19.1
title: Mandatory state.md Update Hook
plan: plan-2025-12-sprint-19-methodology
type: feature
priority: P0
complexity: 40
status: done
depends_on: []
tags:
- hooks
- workflow
- methodology
---

# Objective

Block task completion if state.md hasn't been updated. Prevent Claude from marking tasks done without documenting what was accomplished.

# Implementation

Add a pre-completion hook to `task update` that:
1. Checks if state.md was modified since task started
2. Verifies "What Was Just Done" section has new content
3. Blocks completion with helpful message if not updated

## Hook Logic

```python
def check_state_updated(task_id: str, start_time: datetime) -> bool:
    """Check if state.md was updated since task started."""
    state_path = ".paircoder/context/state.md"
    state_mtime = os.path.getmtime(state_path)
    return state_mtime > start_time.timestamp()
```

## CLI Behavior

```bash
$ bpsai-pair task update T19.1 --status done

‚ùå Cannot complete task: state.md not updated since task started.

Please update .paircoder/context/state.md with:
- Mark T19.1 as done in task list
- Add session entry under "What Was Just Done"
- Update "What's Next" section

Then retry: bpsai-pair task update T19.1 --status done
```

## Bypass Option

```bash
bpsai-pair task update T19.1 --status done --skip-state-check
# Logs warning but allows completion
```

# Acceptance Criteria

- [ ] Hook fires before task completion (when --status done)
- [ ] Checks state.md modification time against task start time
- [ ] Blocks completion with helpful error message
- [ ] `--skip-state-check` flag bypasses for emergencies
- [ ] Warning logged when bypass used
- [ ] Unit tests cover both paths (block and bypass)

# Files to Modify

- `src/bpsai_pair/planning/task_commands.py`
- `tests/test_task_commands.py`

# Dependencies

None