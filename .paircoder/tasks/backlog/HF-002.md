---
id: HF-002
title: Fix Windows encoding for file operations
plan: hotfix
type: bugfix
priority: P2
complexity: 30
status: planned
sprint: hotfix
tags:
- windows
- encoding
- cross-platform
---

# Objective

Fix `UnicodeDecodeError` on Windows by adding explicit `encoding="utf-8"` to all `pathlib.read_text()` and `write_text()` calls in the CLI codebase.

# Background

Python's `pathlib.Path.read_text()` and `write_text()` use `locale.getpreferredencoding()` by default:
- **Linux/macOS**: UTF-8 (works fine)
- **Windows**: cp1252 (fails on Unicode characters)

When PairCoder context files contain Unicode box-drawing characters (`├`, `└`, `│`, `─`, etc.) or emojis, Windows users encounter:

```
UnicodeDecodeError: 'charmap' codec can't decode byte 0x9c in position 1234: character maps to <undefined>
```

## Files With Unicode Characters

Context files commonly use box-drawing for tree diagrams:
```
├── api-server/
│   ├── .paircoder/
│   └── contracts/
└── workers/
```

These files fail to load on Windows without explicit UTF-8 encoding.

# Scope

| Location | `read_text()` | `write_text()` | Total |
|----------|---------------|----------------|-------|
| CLI code (`tools/cli/bpsai_pair/`) | 81 | 39 | 120 |
| Cookiecutter scripts | 2 | 0 | 2 |
| **Total** | **83** | **39** | **122** |

## CLI Modules Affected

High-occurrence modules:
- `orchestration/` - planner.py, handoff.py, reviewer.py, orchestrator.py
- `commands/` - core.py, upgrade.py, security.py, budget.py, session.py
- `skills/` - validator.py, exporter.py, suggestion.py, gap_detector.py, installer.py
- `planning/` - commands.py, cli_update_cache.py
- `core/` - ops.py, preconditions.py, hooks.py, task_state.py, deprecation.py
- `context/` - loader.py, cache.py
- `tasks/` - lifecycle.py, changelog.py
- `compaction.py`, `session.py`, `migrate.py`
- `security/` - dependencies.py
- `release/` - template.py, commands.py
- `trello/` - progress.py
- `benchmarks/` - validation.py

## Cookiecutter Scripts

- `.claude/skills/managing-task-lifecycle/scripts/check_completion.py`
- `.claude/skills/managing-task-lifecycle/scripts/validate_task_status.py`

## Already Fixed (9 files)

These files already specify `encoding="utf-8"`:
- `mcp/server.py`
- `mcp/tools/context.py`
- `mcp/tools/trello.py`
- `planning/state.py`
- `flows/parser.py`
- `trello/fields.py`
- `security/secrets.py`
- `tokens.py`

# Implementation Plan

## 1. Fix read_text() Calls

Change all instances from:
```python
content = path.read_text()
```

To:
```python
content = path.read_text(encoding="utf-8")
```

## 2. Fix write_text() Calls

Change all instances from:
```python
path.write_text(content)
```

To:
```python
path.write_text(content, encoding="utf-8")
```

## 3. Fix Cookiecutter Scripts

Update the two Python scripts in the cookiecutter template that run on user machines.

## 4. Verification

Run tests on Windows or use the following to simulate:
```python
# Test that UTF-8 encoding works
from pathlib import Path
test_content = "├── test\n└── end"
Path("test.md").write_text(test_content, encoding="utf-8")
assert Path("test.md").read_text(encoding="utf-8") == test_content
```

# Acceptance Criteria

- [ ] All `read_text()` calls in `bpsai_pair/` specify `encoding="utf-8"`
- [ ] All `write_text()` calls in `bpsai_pair/` specify `encoding="utf-8"`
- [ ] Cookiecutter scripts specify `encoding="utf-8"`
- [ ] All existing tests pass
- [ ] Manual test on Windows confirms Unicode files load correctly

# Verification

```bash
# Verify no unencoded read_text() calls remain
grep -r "\.read_text()" tools/cli/bpsai_pair --include="*.py" | grep -v "encoding" | wc -l
# Expected: 0

# Verify no unencoded write_text() calls remain
grep -r "\.write_text(" tools/cli/bpsai_pair --include="*.py" | grep -v "encoding" | wc -l
# Expected: 0

# Run test suite
cd tools/cli && pytest
```

# Notes

- This is a mechanical fix with low risk
- UTF-8 encoding is backwards compatible with ASCII
- Consider adding a pre-commit hook or linting rule to catch future regressions
- Alternative: Set `PYTHONUTF8=1` environment variable, but explicit encoding is more reliable
