---
id: T29.4
title: Create contained-auto Command
status: done
priority: P0
complexity: 40
plan: plan-2026-01-sprint-29-contained-autonomy
depends_on:
- T29.3
---

# Objective

Implement the main command that starts a contained autonomous session with git checkpoint and sandbox activation.

# Files to Update

| File | Change |
|------|--------|
| `tools/cli/bpsai_pair/commands/session.py` | Add `contained-auto` command |
| `tools/cli/bpsai_pair/cli.py` | Register session command group if needed |

# Implementation Plan

1. Create `contained-auto` command with options:
   - `task: Optional[str]` - task to work on
   - `--skip-checkpoint` - skip git checkpoint creation

2. Command flow:
   - Load config
   - Warn if sandbox not enabled in config
   - Create git checkpoint (if `auto_checkpoint` enabled)
   - Initialize and activate `ContainmentManager`
   - Set environment variables for detection
   - Log session start

3. Set environment variables:
   - `PAIRCODER_CONTAINMENT=1`
   - `PAIRCODER_CONTAINMENT_CHECKPOINT=<checkpoint_id>`

4. Implement exit handler to clean up containment state

5. Integrate with existing orchestrate module if applicable

# Acceptance Criteria

- [ ] `bpsai-pair contained-auto` starts containment session
- [ ] Git checkpoint created on entry (if `auto_checkpoint` enabled)
- [ ] Command skips checkpoint with `--skip-checkpoint`
- [ ] Containment manager activated correctly
- [ ] Environment variables set
- [ ] Session start logged
- [ ] Exit handler cleans up containment state

# Verification

```bash
# Test command help
bpsai-pair contained-auto --help

# Test starting sandbox (with clean repo)
git status  # should be clean
bpsai-pair contained-auto
# Should see checkpoint created message
# Should see containment active message

# Check environment
echo $PAIRCODER_CONTAINMENT

# Check checkpoint exists
git tag -l "containment-*"
```

# Implementation Notes

```python
# tools/cli/bpsai_pair/commands/session.py

import os
import typer
from typing import Optional

from bpsai_pair.core.config import load_config
from bpsai_pair.security.containment import ContainmentManager
from bpsai_pair.security.checkpoint import create_sandbox_checkpoint

session_app = typer.Typer()

@session_app.command("contained-auto")
def contained_auto(
    task: Optional[str] = typer.Argument(None, help="Task to work on"),
    skip_checkpoint: bool = typer.Option(False, "--skip-checkpoint", help="Skip git checkpoint"),
):
    """
    Start a contained autonomous session.

    In this mode, Claude Code cannot modify:
    - .claude/ directory (agents, commands, skills)
    - Enforcement code (security/, core/, orchestration/)
    - Config files (config.yaml, CLAUDE.md, AGENTS.md)

    A git checkpoint is created automatically for easy rollback.
    """
    config = load_config()
    project_root = find_paircoder_dir().parent

    if not config.containment.enabled:
        console.print("[yellow]Warning: Containment not enabled in config[/yellow]")
        if not typer.confirm("Enable sandbox for this session?"):
            raise typer.Abort()

    checkpoint_id = None

    # Create checkpoint
    if config.containment.auto_checkpoint and not skip_checkpoint:
        checkpoint_id = create_sandbox_checkpoint()
        console.print(f"[green]✓[/green] Checkpoint created: {checkpoint_id}")

    # Initialize sandbox
    containment = ContainmentManager(config.containment, project_root)
    containment.activate()

    console.print("[green]✓[/green] Contained autonomy mode active")
    console.print("[dim]Protected paths are read-only[/dim]")

    # Set environment for Claude Code to detect
    os.environ["PAIRCODER_CONTAINMENT"] = "1"
    if checkpoint_id:
        os.environ["PAIRCODER_CONTAINMENT_CHECKPOINT"] = checkpoint_id

    if task:
        console.print(f"[blue]Task:[/blue] {task}")
```

# Test Cases

- Command creates checkpoint when `auto_checkpoint` enabled
- Command skips checkpoint with `--skip-checkpoint`
- Containment manager activated correctly
- Environment variables set
- Exit handler called on completion