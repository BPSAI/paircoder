---
id: T29.8
title: Create Auto-Checkpoint on Containment Entry
status: done
priority: P1
complexity: 25
plan: plan-2026-01-sprint-29-contained-autonomy
depends_on: [T29.4]
---

# Objective

Ensure a git checkpoint is created before entering containment mode, enabling easy rollback if needed.

# Files to Update

| File | Change |
|------|--------|
| `tools/cli/bpsai_pair/security/checkpoint.py` | Add `create_containment_checkpoint()` and `rollback_to_checkpoint()` functions |
| `tools/cli/bpsai_pair/commands/session.py` | Add `containment rollback` command |

# Implementation Plan

1. Create `create_containment_checkpoint()` function:
   - Generate timestamp-based checkpoint name
   - Stash uncommitted changes if dirty working directory
   - Create lightweight git tag
   - Return checkpoint ID

2. Create `rollback_to_checkpoint(checkpoint_id: str)` function:
   - Verify checkpoint exists
   - Show diff of changes since checkpoint
   - Prompt for confirmation
   - Reset to checkpoint
   - Pop stash if one was created

3. Add `containment rollback` command:
   - Find most recent containment checkpoint
   - Show preview of what will be rolled back
   - Execute rollback with confirmation

4. Handle edge cases:
   - Warn if dirty working directory
   - Handle missing checkpoint gracefully
   - Preserve wanted changes if possible

# Acceptance Criteria

- [x] Checkpoint created with descriptive name format (`containment-YYYYMMDD-HHMMSS`)
- [x] Checkpoint ID stored in environment
- [x] `bpsai-pair containment rollback` restores checkpoint
- [x] Uncommitted changes stashed before checkpoint
- [x] Warning if dirty working directory

# Verification

```bash
# Test checkpoint creation
bpsai-pair contained-auto --help  # Should mention checkpoint

# Create checkpoint manually (test function)
python -c "
from bpsai_pair.security.checkpoint import create_containment_checkpoint
print(create_containment_checkpoint())
"

# Verify tag created
git tag -l "containment-*"

# Test rollback
bpsai-pair containment rollback --dry-run
```

# Implementation Notes

```python
# tools/cli/bpsai_pair/security/checkpoint.py

from datetime import datetime
from bpsai_pair.core.ops import run_git

def create_containment_checkpoint() -> str:
    """
    Create a checkpoint for sandbox entry.

    Returns checkpoint ID that can be used for rollback.
    """
    timestamp = datetime.now().strftime("%Y%m%d-%H%M%S")
    checkpoint_name = f"containment-{timestamp}"

    # Check for uncommitted changes
    status = run_git("status", "--porcelain")
    has_changes = bool(status.stdout.strip())

    stash_created = False
    if has_changes:
        # Stash any uncommitted changes
        stash_result = run_git("stash", "push", "-m", f"Auto-stash for {checkpoint_name}")
        stash_created = "Saved working directory" in stash_result.stdout

    # Create lightweight tag as checkpoint
    run_git("tag", checkpoint_name, "-m", f"Sandbox entry checkpoint at {timestamp}")

    return checkpoint_name


def rollback_to_checkpoint(checkpoint_id: str, force: bool = False) -> bool:
    """
    Rollback to a containment checkpoint.

    Returns True if rollback succeeded.
    """
    # Verify checkpoint exists
    result = run_git("tag", "-l", checkpoint_id)
    if checkpoint_id not in result.stdout:
        raise ValueError(f"Checkpoint not found: {checkpoint_id}")

    # Show changes since checkpoint
    diff = run_git("diff", f"{checkpoint_id}..HEAD", "--stat")
    if diff.stdout.strip():
        console.print("[yellow]Changes since checkpoint:[/yellow]")
        console.print(diff.stdout)

    if not force:
        if not typer.confirm("Rollback to checkpoint?"):
            return False

    # Reset to checkpoint
    run_git("reset", "--hard", checkpoint_id)

    # Pop stash if exists
    stash_list = run_git("stash", "list")
    if f"Auto-stash for {checkpoint_id}" in stash_list.stdout:
        run_git("stash", "pop")

    return True
```

# Test Cases

- Checkpoint created with correct name format
- Stash created for dirty working directory
- Clean working directory doesn't stash
- Rollback restores to checkpoint state
