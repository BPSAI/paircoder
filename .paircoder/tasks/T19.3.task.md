---
id: T19.3
title: Compaction Detection and Recovery
plan: plan-2025-12-sprint-19-methodology
type: feature
priority: P1
complexity: 55
status: done
depends_on:
- T19.2
tags:
- session
- context
- compaction
---

# Objective

Detect when Claude's auto-compaction has occurred and restore context from state.md. Compaction loses detailed context, breaking ongoing work.

# Implementation

## Detection Methods

1. **Token count drop:** Significant context reduction
2. **Missing file references:** Files previously in context now unknown
3. **Explicit marker:** Check for compaction signal

## Recovery Flow

```
⚠️ Context compaction detected. Restoring from state.md...

Recovered context:
- Project: PairCoder v2.7.0
- Current task: T19.3 (Compaction Detection)
- Recent changes: hooks.py, lifecycle.py

Note: Some conversation details were compacted.
Run `bpsai-pair pack` to create full context snapshot.
```

## Integration with /compact

When user runs `/compact`, PairCoder should:
1. Auto-save current state to state.md
2. Create context snapshot
3. Provide recovery instructions

# Acceptance Criteria

- [ ] Detects compaction event (token count drop or explicit signal)
- [ ] Auto-restores from state.md when compaction detected
- [ ] Shows what context was recovered
- [ ] Integrates with Claude Code `/compact` command (via hooks)
- [ ] Test simulates compaction scenario
- [ ] `bpsai-pair pack` creates recovery snapshot

# Files to Modify

- `src/bpsai_pair/session/` - Add compaction detection
- `src/bpsai_pair/commands/pack.py` - Enhance for recovery
- `.claude/hooks/` - Add compaction hook
- `tests/test_compaction.py`

# Dependencies

T19.2 (session detection infrastructure)