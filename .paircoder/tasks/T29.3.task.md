---
id: T29.3
title: Implement Directory Locking in sandbox.py
status: pending
priority: P0
complexity: 45
plan: plan-2026-01-sprint-29-contained-autonomy
depends_on: [T29.2]
---

# Objective

Create the filesystem locking mechanism that prevents writes to protected directories and files.

# Files to Update

| File | Change |
|------|--------|
| `tools/cli/bpsai_pair/security/sandbox.py` | Add `SandboxManager` class and `SandboxViolationError` |

# Implementation Plan

1. Create `SandboxViolationError` exception class

2. Create `SandboxManager` class with:
   - `__init__(config: SandboxConfig, project_root: Path)`
   - `_build_locked_paths()` - resolve all locked paths
   - `is_path_locked(path: Path) -> bool`
   - `check_write_allowed(path: Path) -> None` - raises `SandboxViolationError`
   - `activate()` / `deactivate()` methods

3. Handle path resolution correctly:
   - Resolve relative paths to absolute
   - Resolve symlinks to prevent bypass
   - Handle glob patterns in `locked_directories`

4. Implement locked path checking:
   - Check if path matches a locked file exactly
   - Check if path is within a locked directory
   - Handle parent directory traversal

# Acceptance Criteria

- [ ] `SandboxManager` class created
- [ ] `is_path_locked(path)` method works correctly
- [ ] `check_write_allowed(path)` raises `SandboxViolationError` for locked paths
- [ ] Relative and absolute paths handled correctly
- [ ] Symlink resolution prevents bypass
- [ ] Glob patterns supported in `locked_directories`

# Verification

```bash
# Run sandbox tests
pytest tests/security/test_sandbox.py -v

# Manual test
python -c "
from pathlib import Path
from bpsai_pair.security.sandbox import SandboxManager
from bpsai_pair.core.config import SandboxConfig

config = SandboxConfig(
    enabled=True,
    locked_directories=['.claude/agents/'],
    locked_files=['CLAUDE.md']
)
manager = SandboxManager(config, Path.cwd())
print(manager.is_path_locked(Path('.claude/agents/planner.md')))  # True
print(manager.is_path_locked(Path('src/main.py')))  # False
"
```

# Implementation Notes

```python
# tools/cli/bpsai_pair/security/sandbox.py

class SandboxViolationError(Exception):
    """Raised when attempting to modify locked resources."""
    pass

class SandboxManager:
    def __init__(self, config: SandboxConfig, project_root: Path):
        self.config = config
        self.project_root = project_root.resolve()
        self._locked_paths: set[Path] = set()
        self._locked_dirs: set[Path] = set()
        self._active = False
        self._build_locked_paths()

    def _build_locked_paths(self) -> None:
        """Resolve all locked paths."""
        for dir_pattern in self.config.locked_directories:
            path = self.project_root / dir_pattern
            self._locked_dirs.add(path.resolve())

        for file_path in self.config.locked_files:
            path = self.project_root / file_path
            self._locked_paths.add(path.resolve())

    def is_path_locked(self, path: Path) -> bool:
        """Check if a path is within a locked directory or is a locked file."""
        resolved = (self.project_root / path).resolve()

        # Check locked files
        if resolved in self._locked_paths:
            return True

        # Check locked directories
        for locked_dir in self._locked_dirs:
            if resolved == locked_dir or locked_dir in resolved.parents:
                return True

        return False

    def check_write_allowed(self, path: Path) -> None:
        """Raise SandboxViolationError if write not allowed."""
        if not self._active:
            return
        if self.is_path_locked(path):
            raise SandboxViolationError(
                f"Cannot modify locked path: {path}\n"
                f"This path is protected in contained autonomy mode."
            )
```

# Test Cases

- Locked directory blocks child file writes
- Locked file blocks specific file writes
- Non-locked paths allow writes
- Symlinks to locked paths are blocked
- Parent directory traversal doesn't bypass locks
