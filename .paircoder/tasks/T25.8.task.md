---
id: T25.8
title: Create tokens.py estimation module
type: feature
status: done
priority: P1
complexity: 50
plan: plan-2025-12-sprint-25-epic003-token-budget
effort: L
---

# T25.8: Create tokens.py estimation module

## Objective

Create a token counting and budget estimation module using tiktoken.

## Context

To prevent context compaction, we need to proactively estimate token usage before and during tasks.

## Implementation

Create `tools/cli/bpsai_pair/tokens.py`:

```python
"""Token counting and budget estimation."""
import tiktoken
from pathlib import Path

def count_tokens(text: str, model: str = "cl100k_base") -> int:
    """Count tokens in text using tiktoken."""

def count_file_tokens(path: Path) -> int:
    """Count tokens in a file."""

def estimate_task_tokens(task_id: str, files: list[Path], complexity: int) -> dict:
    """Estimate total tokens for a task.

    Returns:
        {
            "base_context": 15000,
            "task_file": 500,
            "source_files": 8000,
            "estimated_output": 3000,
            "total": 26500,
            "budget_percent": 26.5
        }
    """

def get_budget_status(estimated: int, model: str = "claude-sonnet-4-5") -> dict:
    """Get budget status with thresholds.

    Returns:
        {
            "used": 26500,
            "limit": 100000,
            "remaining": 73500,
            "percent": 26.5,
            "status": "ok",  # ok | warning | critical
            "message": "Budget healthy"
        }
    """

MODEL_LIMITS = {
    "claude-sonnet-4-5": 100000,
    "claude-opus-4-5": 100000,
    "claude-haiku-4-5": 100000,
}

THRESHOLDS = {
    "info": 50,      # 50% - informational
    "warning": 75,   # 75% - consider breaking up
    "critical": 90,  # 90% - compaction likely
}
```

## Acceptance Criteria

- [ ] `count_tokens()` works with tiktoken
- [ ] `count_file_tokens()` handles file encoding properly
- [ ] `estimate_task_tokens()` provides accurate breakdown
- [ ] `get_budget_status()` returns correct status levels
- [ ] MODEL_LIMITS defined for all Claude models
- [ ] THRESHOLDS configurable
- [ ] Unit tests cover all functions
- [ ] Handle edge cases (empty files, binary files, missing files)

## Files to Create

- `bpsai_pair/tokens.py`
- `tests/test_tokens.py`

## Dependencies

- T25.7: Add tiktoken dependency

## Notes

Token counts are estimates - Claude's actual tokenization may differ slightly. Use conservative estimates (round up) for safety.