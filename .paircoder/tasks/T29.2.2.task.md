---
id: T29.2.2
title: Planning and Task Commands Audit
plan: plan-2026-01-sprint-29-2-comprehensive-audit
type: feature
priority: P0
complexity: 45
status: done
sprint: 29.2
tags: [audit, planning, task, cli]
depends_on: []
---

# Objective

Comprehensive audit of the Planning and Task Commands module (`planning/commands.py`) to verify all commands work correctly, assess code quality, and identify issues.

# Implementation Plan

1. Analyze planning/commands.py module structure
2. Test all plan commands (8 commands)
3. Test all task commands (10 commands)
4. Test intent and standup commands (5 commands)
5. Assess code quality and complexity
6. Run related tests
7. Document findings

# Acceptance Criteria

- [x] All plan commands tested
- [x] All task commands tested
- [x] Intent and standup commands tested
- [x] Code quality assessment completed
- [x] Test coverage assessed
- [x] Findings documented

# Verification

All tests passed. See findings below.

---

# Audit Findings

## 1. File Location and Structure

**File:** `tools/cli/bpsai_pair/planning/commands.py`
**Lines:** 2,138 (MONOLITHIC - needs decomposition)
**Functions:** 35 (23 commands + 12 helpers)
**Command Groups:** 4 (plan, task, intent, standup)

## 2. Commands Tested

### Plan Commands (8 commands)

| Command | Help | Functional | Status | Notes |
|---------|------|------------|--------|-------|
| `plan new` | PASS | Not tested | Working | Creates plan files |
| `plan list` | PASS | PASS | Working | Shows 2 plans |
| `plan show` | PASS | PASS | Working | Shows plan details |
| `plan tasks` | N/A | Implicit | Working | Via plan show |
| `plan status` | PASS | PASS | Working | Shows progress bars |
| `plan sync-trello` | N/A | Not tested | Untested | Requires Trello |
| `plan estimate` | PASS | PASS | Working | Token estimation |
| `plan add-task` | N/A | Not tested | Untested | |

### Task Commands (10 commands)

| Command | Help | Functional | Status | Notes |
|---------|------|------------|--------|-------|
| `task list` | PASS | PASS | Working | Shows manual edit warnings |
| `task show` | PASS | PASS | Working | Shows time tracking |
| `task update` | PASS | PASS | Working | Enforcement gates work |
| `task next` | PASS | **ISSUE** | Bug | Returns "No tasks available" |
| `task auto-next` | PASS | PASS | Working | Assigned task correctly |
| `task archive` | PASS | PASS | Working | Dry-run works |
| `task restore` | N/A | Not tested | Untested | |
| `task list-archived` | PASS | PASS | Working | No archived tasks |
| `task cleanup` | N/A | Not tested | Untested | |
| `task changelog-preview` | PASS | Not tested | Untested | |

### Intent Commands (3 commands)

| Command | Help | Functional | Status | Notes |
|---------|------|------------|--------|-------|
| `intent detect` | PASS | PASS | Working | Detects "feature" intent |
| `intent should-plan` | PASS | PASS | Working | Returns YES/NO |
| `intent suggest-flow` | N/A | Implicit | Working | Via should-plan |

### Standup Commands (2 commands)

| Command | Help | Functional | Status | Notes |
|---------|------|------------|--------|-------|
| `standup generate` | PASS | PASS | Working | Generates markdown |
| `standup post` | N/A | Not tested | Untested | Requires Trello |

## 3. Bugs Found

### BUG-001: `task next` returns "No tasks available"

**Severity:** Medium
**Location:** `planning/commands.py:1528-1571`
**Description:** Running `bpsai-pair task next` returns "No tasks available. Create a plan first!" even when 15+ pending tasks exist.
**Expected:** Should return the next highest-priority pending task.
**Workaround:** Use `task auto-next --plan <plan-id>` instead.

### BUG-002: `task archive --completed` requires plan

**Severity:** Low
**Location:** `planning/commands.py:1604-1707`
**Description:** Running `bpsai-pair task archive --completed --dry-run` returns "No plan specified and no active plan found" even when plans exist.
**Expected:** Should auto-detect active plan or list all completed tasks.

## 4. Code Quality Assessment

### Metrics

| Metric | Value | Assessment |
|--------|-------|------------|
| Total lines | 2,138 | CRITICAL - needs decomposition |
| Functions | 35 | High density |
| Max cyclomatic complexity | 28 | HIGH - plan_sync_trello |
| Functions CC >10 | 6 | Needs refactoring |

### High Complexity Functions (CC > 10)

| Function | CC | Issue |
|----------|----|----|
| `plan_sync_trello()` | 28 | CRITICAL - needs extraction |
| `task_update()` | 27 | CRITICAL - enforcement gates |
| `plan_status()` | 22 | HIGH |
| `task_archive()` | 19 | HIGH |
| `plan_show()` | 14 | MODERATE |
| `_check_state_md_updated()` | 11 | MODERATE |

### Positive Findings

- No TODOs/FIXMEs
- Enforcement gates are well-implemented
- Good error messages
- JSON output support on most commands
- Manual edit detection works

### Negative Findings

- File is 4x recommended size (500-700 lines ideal)
- High cyclomatic complexity in key functions
- Deep nesting in sync-trello logic

## 5. Test Coverage

### Tests Found

| Test File | Lines | Coverage |
|-----------|-------|----------|
| test_plan_estimate.py | 461 | Excellent |
| test_plan_sync_trello_e2e.py | 605 | Good (E2E) |
| test_mcp_tools_planning.py | 113 | Partial |
| test_mcp_tools_planning_full.py | 841 | Good |

### Test Results

- **14 tests pass** for plan estimate
- **Error in test_flows.py** - imports non-existent `bpsai_pair.flows` module (DEAD CODE)

### Coverage Gaps

- `task next` command - NOT TESTED
- `task update` enforcement gates - NOT TESTED
- Intent detection commands - NOT TESTED
- Standup commands - NOT TESTED
- Manual edit detection - NOT TESTED

## 6. Dead Code Found

### DEAD-001: test_flows.py

**File:** `tests/test_flows.py`
**Issue:** Imports `bpsai_pair.flows` which doesn't exist
**Action:** Delete test file or implement flows module

## 7. Dependencies

### Internal (10 modules)
- planning/models.py, parser.py, state.py
- planning/token_estimator.py, standup.py, intent_detection.py
- planning/auto_assign.py, cli_update_cache.py
- core/ops.py, core/hooks.py
- trello/auth.py, client.py, sync.py
- tasks module

### External
- typer, rich, yaml, json, re, os, datetime, pathlib

## 8. Recommendations

### Critical (Before v3.0)

1. **Decompose planning/commands.py** into:
   - `planning/plan_commands.py` (plan new, list, show, tasks, status)
   - `planning/task_commands.py` (task list, show, update, etc.)
   - `planning/trello_sync.py` (sync-trello logic)
   - `planning/archive_commands.py` (archive, restore, cleanup)

2. **Fix BUG-001** - `task next` not finding tasks

3. **Delete test_flows.py** - dead test file

### High Priority

4. Add tests for `task next`, `task update` enforcement
5. Add tests for intent detection commands
6. Extract `task_update()` enforcement logic into helper

### Medium Priority

7. Reduce complexity of `plan_sync_trello()` (CC=28)
8. Add return type annotations
9. Document regex patterns

---

## Summary

**Overall Status:** FUNCTIONAL but MONOLITHIC

The planning/commands.py module is functional but is the largest file in the codebase at 2,138 lines. It requires decomposition as part of EPIC-005. Two bugs were found:
1. `task next` returns "No tasks available" incorrectly
2. `task archive --completed` requires explicit plan

Key statistics:
- 23 commands across 4 groups
- 6 functions with cyclomatic complexity >10
- 14 tests pass for plan estimation
- 1 dead test file found (test_flows.py)

**Blocking for v3.0:** Module decomposition required before adding new features.
